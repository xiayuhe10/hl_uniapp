<template>
	<view class="video-player">
		<div class="close" @click="close">
			<text class="close-text">Ã—</text>
		</div>
		<div class="closed" @click="saveVideo">
			<text class="">ğŸ’¾</text>
		</div>
		
		<!-- <video :src="src" controls class="video-size" id="editVideo" show-play-btn="true" show-fullscreen-btn="false" show-progress="true" :autoplay="true" :muted="false"  ></video> -->
		<video id="editVideo" :auto-play="true" v-if="src" :controls="true" :enable-play-gesture="true" :autoplay="true"
			:loop="true" show-mute-btn="true" x-webkit-airplay="true" webkit-playsinline="true" 
			:auto-pause-if-navigate="true"
			:auto-pause-if-open-native="true"
			x5-video-player-type="h5" x5-video-orientation="portraint" preload="auto" class="video" :src="src"
			:poster="cover"></video>

	</view>
</template>

<script>
	import webUrl from '@/common/config.js';
	export default {
		data() {
			return {
				src: '',
				cover: ''
			}
		},
		onHide() {
			uni.createVideoContext('editVideo').pause(); //æ‰§è¡Œæš‚åœ
			uni.createVideoContext('editVideo').stop(); //æ‰§è¡Œæš‚åœ
			console.info("å…³é—­é¡µé¢")
		},
		onBackPress(e) {
		    if (e.from == "backbutton") {
		         console.log("ç”¨æˆ·ä½¿ç”¨äº†ç‰©ç†è¿”å›é”®");
		         //åœ¨è¿™é‡Œæ“ä½œä»£ç 
		        return true//å¦‚æœä¸å†™å°±ä¼šè¿”å›
		    }
		},
		onLoad() {
			console.info("æ˜¾ç¤ºæ˜¾ç¤º")
			uni.createVideoContext('editVideo').stop(); //æ‰§è¡Œæš‚åœ
			uni.createVideoContext('editVideo').play(); //æ‰§è¡Œæš‚åœ
			uni.$on('chat-video-player', (data) => {
				if (data.content.url == '' && data.content.url) {
					this.src =webUrl.fileURL+ data.content
				} else{
					this.src =webUrl.fileURL+ data.content.url
				}
				this.cover = webUrl.fileURL+data.content.url
			})
		},
		onUnload() {
			uni.$off('chat-video-player')
			console.info("é€€å‡º")
		},
		methods: {
			close() {
				this.src = ''
				let win = uni.getCurrentSubNVue()
				win.hide('slide-out-bottom')
				uni.createVideoContext('editVideo').pause(); //æ‰§è¡Œæš‚åœ
				uni.createVideoContext('editVideo').stop(); //æ‰§è¡Œæš‚åœ

			},
			// ä¿å­˜æŒ‰é’®
			saveMyVideo() {
				let that = this
				// æ‰“å¼€loadingç­‰å¾…
				uni.showLoading({
					mask: true,
					title: 'åŠ è½½ä¸­'
				})
				// å…ˆä¸‹è½½è§†é¢‘
				uni.downloadFile({
					url: that.src,
					success: (res) => {
						if (res.statusCode === 200) {
							// å…³é—­loading
							uni.hideLoading()
							// ä¿å­˜è§†é¢‘åˆ°æ‰‹æœºç›¸å†Œ
							uni.saveVideoToPhotosAlbum({
								filePath: res.tempFilePath,
								success: function() {
									// æˆåŠŸæç¤º
									uni.showToast({
										title: 'ä¿å­˜æˆåŠŸ',
										icon: 'success',    //å¦‚æœè¦çº¯æ–‡æœ¬ï¼Œä¸è¦iconï¼Œå°†å€¼è®¾ä¸º'none'
										duration: 2000    //æŒç»­æ—¶é—´ä¸º 2ç§’
									})  
								}
							})
						}

					}
				})
			},
			saveVideo() {
				let that = this
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®è®¤è¦ä¿å­˜è¯¥è§†é¢‘å—ï¼Ÿ',
					success: function(res) {
						if (res.confirm) {
							console.log('ç‚¹å‡»äº†ç¡®è®¤')
							that.saveMyVideo()
						} else {
							console.log('ç‚¹å‡»äº†å–æ¶ˆ')
						}
					}
				})
			}
		}
	}
</script>
<style>
	.video-player {
		background-color: #000000;
		color: #fff;
		width: 750rpx;
		height: 1634rpx;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		z-index: -999;
	}

	.video {
		width: 750rpx;
		height: 1634rpx;
	}

	.close {
		border-radius: 25px;
		height: 40px;
		width: 40px;
		background-color: rgba(255, 255, 255, .6);
		position: fixed;
		top: 35px;
		right: 30px;
		justify-content: center;
		align-items: center;
	}

	.close-text {
		font-size: 30px;
		margin-top: -5px;
		color: #fff;

	}

	.closed {
		border-radius: 25px;
		height: 40px;
		width: 40px;
		background-color: rgba(255, 255, 255, .6);
		color: white;
		position: fixed;
		top: 35px;
		left: 35px;
		justify-content: center;
		align-items: center;
	}

	.close-textd {
		font-size: 30px;
		margin-top: -5px;
		color: #fff;
	}
</style>
